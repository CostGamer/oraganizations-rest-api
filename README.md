# Organization Catalog API

## Описание проекта

**Organization Catalog API** — это RESTful API для работы с каталогом организаций и классификации их деятельности. С помощью данного API вы сможете:  
- Получать список организаций, находящихся в конкретных зданиях.  
- Искать организации по названию, типу деятельности или географическому расположению.  
- Использовать древовидную классификацию видов деятельности, ограниченную до трёх уровней вложенности.  
- Выполнять запросы к API с использованием токена.  

### Работа с токенами
Для работы с API требуется наличие токена, который можно получить с помощью следующих методов:  
- **POST** `/issue_token` — запрос на выдачу нового токена.  
- **GET** `/get_all_tokens` — получение списка всех выданных токенов.  

#### Ограничения
- Максимальное количество активных токенов на одного пользователя: **5**.  
- Лимит запросов с использованием одного токена: **100 запросов в час**.  

### Основные технологии:
- **Python** 3.12
- **FastAPI** — фреймворк для создания API
- **SQLAlchemy ORM** — для работы с базой данных
- **Alembic** — для миграций базы данных
- **Pydantic** — для валидации данных
- **Pytest** — для тестирования
- **Docker** — для контейнеризации и развертывания
- **PostgreSQL** - реляционная база данных, используемая для хранения и управления структурированными данными
- **PostGIS** - расширение для PostgreSQL, добавляющее поддержку географических объектов и операций с ними

## Установка

### Вариант 1: Локальная установка

1. **Клонирование репозитория**

   Для начала клонируйте репозиторий:

   ```bash
   git clone https://github.com/CostGamer/org_catalog.git
   cd org_catalog
   ```

2. **Установка зависимостей**

   Убедитесь, что у вас установлен **Poetry** для управления зависимостями.

   - Установите зависимости с помощью **Poetry**:

   ```bash
   poetry install
   ```

   - Активируйте виртуальное окружение:

   ```bash
   poetry shell
   ```

3. **Установка pre-commit хуков (dev режим)**

   Для установки pre-commit хуков, используйте следующую команду:

   ```bash
   pre-commit install
   ```

4. **Создание переменных окружения**

   Создайте файл `.env` на примере `.env.example`

5. **Настройка базы данных**

   Запустите PostgreSQL с PostGIS через Docker:

   ```bash
    docker run --name postgres-postgis \
    --env-file=.env \
    -p 127.0.0.1:5432:5432 \
    -d postgis/postgis:15-3.3
   ```

6. **Запуск приложения**

   Для запуска приложения выполните команду:

   ```bash
   ./starts.sh
   ```

7. **Миграции базы данных**

    Для применения миграций базы данных используйте следующую команду:

    ```bash
    alembic upgrade head
    ```

8. **Тестовые данные**
    
    Импортируйте тестовые данные из файла **test_data.sql** 

Сервис будет доступен на `localhost:8000`.

### Вариант 2: Установка через Docker Compose

1. **Создание переменных окружения**

   Создайте файл `.env` на примере `.env.example`

2. **Запуск приложения через Docker Compose**

   Если вы хотите запустить приложение с помощью Docker, просто выполните следующую команду:

   ```bash
   docker-compose up --build -d
   ```

3. **Тестовые данные**
    
    Импортируйте тестовые данные из файла **test_data.sql** 

Сервис будет доступен на `localhost:8000`.


## Тестирование

1. Создайте тестовую базу данных:
    ```sql
    CREATE DATABASE mydb_test TEMPLATE mydb OWNER admin;
    ```

2. Настройте параметры подключения в `tests/__init__.py`

3. Запустите тесты:
    ```bash
    pytest -p no:warnings -v #без warning
    ```
    ```bash
    pytest -v 
    ```

## Структура проекта

```bash
├── src                     # Основной каталог с исходным кодом
│   ├── api                 # Маршруты FastAPI и зависимости
│   ├── core                # Общие зависимости
│   ├── DB                  # Работа с базой данных
│   │   └── migrations      # Alembic миграции
│   ├── middleware          # Пользовательские middleware
│   ├── repositories        # Репозитории для работы с БД
│   ├── services            # Бизнес-логика
│   └── main.py             # Точка входа FastAPI приложения
├── tests                   # Тесты
├── .env.example            # Пример конфигурации окружения
├── .github/workflows       # CI/CD пайплайны
├── .pre-commit-config.yaml # Конфигурация pre-commit хуков
├── docker-compose.yml      
├── Dockerfile              
├── poetry.lock             # Файл блокировки Poetry
├── pyproject.toml          # Конфигурация Poetry
├── test_data.sql           # Тестовые данные
└── start.sh                # Скрипт для локального запуска
```

## Контакты

Если у вас возникли вопросы или предложения, можете связаться с нами по почте: `vladimirbryzgalov00@gmail.com`.